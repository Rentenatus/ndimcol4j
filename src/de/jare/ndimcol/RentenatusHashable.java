/**
 * <copyright>
 * Copyright (c) 2025, Janusch Rentenatus. This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License v2.0 which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v20.html
 * </copyright>
 */
package de.jare.ndimcol;

import de.jare.ndimcol.ref.HashStrategy;

/**
 *
 * @author Janusch Rentenatus
 */
public interface RentenatusHashable {

    public final static int LIMIT = (1 << 30);
    public final static int MASK = LIMIT - 1; // 2^30 - 1
    public final static long LONG_MASK = LIMIT - 1; // 2^30 - 1

    final static long[] SEVENTH = {
        1,
        7,
        49,
        343,
        2401,
        16807,
        117649,
        823543,
        5764801,
        40353607,
        282475249,
        903584919,
        956385313,
        252246247,
        691981905,
        548906039,
        621116801,
        52850311,
        369952177,
        442181591,
        947787489,
        192061479,
        270688529,
        821077879,
        378836033,
        504368583,
        309354609,
        17998615,
        125990305,
        881932135,
        804815825,
        265001655,
        781269761,
        100179207,
        701254449,
        613813847,
        1729633,
        12107431,
        84752017,
        593264119,
        931623361,
        78912583,
        552388081,
        645491095,
        223470369,
        490550759,
        212629841,
        414667063,
        755185793,
        991333255,
        496881841,
        256947415,
        724890081,
        779263271,
        86133777,
        602936439,
        999329601,
        552856263,
        648768369,
        246411287,
        651137185,
        262992999,
        767209169,
        1755063,
        12285441,
        85998087,
        601986609,
        992680791,
        506314593,
        322976679,
        113353105,
        793471735,
        185593025,
        225409351,
        504123633,
        307639959,
        5996065,
        41972455,
        293807185,
        982908471,
        437908353,
        917874823,
        1056414641,
        952451543,
        224709857,
        499227175,
        273364753,
        839811447,
        509971009,
        348571591,
        292517489,
        973880599,
        374713249,
        475509095,
        107338193,
        751367351,
        964604161,
        309778183,
        20963633,
        146745431,
        1027218017,
        748075175,
        941558929,
        148461559,
        1039230913,
        832165447,
        456449009,
        1047659415,
        891164961,
        869445607,
        717410129,
        726903607,
        793357953,
        184796551,
        219834033,
        465096407,
        34449377,
        241145639,
        614277649,
        4976247,
        34833729,
        243836103,
        633110897,
        136808983,
        957662881,
        261189223,
        754582737,
        987111863,};
    public final static long[] SEVENTH128 = {
        1,
        467332097,
        21354497,
        809550849,
        684437505,
        719756289,
        915507201,
        197948417,
        714563585,
        317869057,
        81606657,
        5776385,
        90378241,
        335412225,
        740878337,
        233034753,
        959365121,
        772385793,
        745838593,
        879723521,
        100298753,
        555047937,
        96487425,
        872100865,
        734404609,
        757140481,
        940308481,
        210166785,
        714199041,
        304921601,
        56076289,
        1041404929,
        39682049,
        272133121,
        665016321,
        144589825,
        858337281,
        658775041,
        619644929,
        740946945,
        1022681089,
        391105537,
        993703937,
        682992641,
        532713473,
        542866433,
        713451521,
        1044468737,
        462176257,
        40315905,
        852629505,
        751633409,
        811069441,
        1030937601,
        337496065,
        878228481,
        505651201,
        293506049,
        241793025,
        350512129,
        619663361,
        1049246721,
        565520385,
        242226177,
        79364097,
        76934145,
        234936321,
        553370625,
        1032237057,
        597793793,
        323782657,
        210203649,
        257056769,
        464342017,
        832059393,
        286467073,
        975048705,
        750320641,
        686024705,
        782160897,
        1038729217,
        381987841,
        959420417,
        623543297,
        448098305,
        433085441,
        578504705,
        884356097,
        276897793,
        903613441,
        617019393,
        490857473,
        525127681,
        719830017,
        1222657,
        516789249,
        119046145,
        955476993,
        878598145,
        962151425,
        132395009,
        536812545,
        27920385,
        753202177,
        565174273,
        537578497,
        670414849,
        963683329,
        343642113,
        957774849,
        658597889,
        519853057,
        541540353,
        723659777,
        1066211329,
        495453185,
        85127169,
        908975105,
        819513345,
        890483713,
        48144385,
        439979009,
        992245761,
        631202817,
        430592001,
        390413313,
        510666753,
        791352321,};
    public final static long[] SEVENTH16384 = {
        1,
        158728193,
        317456385,
        476184577,
        634912769,
        793640961,
        952369153,
        37355521,
        196083713,
        354811905,
        513540097,
        672268289,
        830996481,
        989724673,
        74711041,
        233439233,
        392167425,
        550895617,
        709623809,
        868352001,
        1027080193,
        112066561,
        270794753,
        429522945,
        588251137,
        746979329,
        905707521,
        1064435713,
        149422081,
        308150273,
        466878465,
        625606657,
        784334849,
        943063041,
        28049409,
        186777601,
        345505793,
        504233985,
        662962177,
        821690369,
        980418561,
        65404929,
        224133121,
        382861313,
        541589505,
        700317697,
        859045889,
        1017774081,
        102760449,
        261488641,
        420216833,
        578945025,
        737673217,
        896401409,
        1055129601,
        140115969,
        298844161,
        457572353,
        616300545,
        775028737,
        933756929,
        18743297,
        177471489,
        336199681,
        494927873,
        653656065,
        812384257,
        971112449,
        56098817,
        214827009,
        373555201,
        532283393,
        691011585,
        849739777,
        1008467969,
        93454337,
        252182529,
        410910721,
        569638913,
        728367105,
        887095297,
        1045823489,
        130809857,
        289538049,
        448266241,
        606994433,
        765722625,
        924450817,
        9437185,
        168165377,
        326893569,
        485621761,
        644349953,
        803078145,
        961806337,
        46792705,
        205520897,
        364249089,
        522977281,
        681705473,
        840433665,
        999161857,
        84148225,
        242876417,
        401604609,
        560332801,
        719060993,
        877789185,
        1036517377,
        121503745,
        280231937,
        438960129,
        597688321,
        756416513,
        915144705,
        131073,
        158859265,
        317587457,
        476315649,
        635043841,
        793772033,
        952500225,
        37486593,
        196214785,
        354942977,
        513671169,
        672399361,
        831127553,};
    public final static long[] SEVENTH2097152 = {
        1,
        989855745,
        905969665,
        822083585,
        738197505,
        654311425,
        570425345,
        486539265,
        402653185,
        318767105,
        234881025,
        150994945,
        67108865,
        1056964609,
        973078529,
        889192449,
        805306369,
        721420289,
        637534209,
        553648129,
        469762049,
        385875969,
        301989889,
        218103809,
        134217729,
        50331649,
        1040187393,
        956301313,
        872415233,
        788529153,
        704643073,
        620756993,
        536870913,
        452984833,
        369098753,
        285212673,
        201326593,
        117440513,
        33554433,
        1023410177,
        939524097,
        855638017,
        771751937,
        687865857,
        603979777,
        520093697,
        436207617,
        352321537,
        268435457,
        184549377,
        100663297,
        16777217,
        1006632961,
        922746881,
        838860801,
        754974721,
        671088641,
        587202561,
        503316481,
        419430401,
        335544321,
        251658241,
        167772161,
        83886081,
        1,
        989855745,
        905969665,
        822083585,
        738197505,
        654311425,
        570425345,
        486539265,
        402653185,
        318767105,
        234881025,
        150994945,
        67108865,
        1056964609,
        973078529,
        889192449,
        805306369,
        721420289,
        637534209,
        553648129,
        469762049,
        385875969,
        301989889,
        218103809,
        134217729,
        50331649,
        1040187393,
        956301313,
        872415233,
        788529153,
        704643073,
        620756993,
        536870913,
        452984833,
        369098753,
        285212673,
        201326593,
        117440513,
        33554433,
        1023410177,
        939524097,
        855638017,
        771751937,
        687865857,
        603979777,
        520093697,
        436207617,
        352321537,
        268435457,
        184549377,
        100663297,
        16777217,
        1006632961,
        922746881,
        838860801,
        754974721,
        671088641,
        587202561,
        503316481,
        419430401,
        335544321,
        251658241,
        167772161,
        83886081,};

    public final static long SEVENTH268435456 = 1;

    public default int combine(int oldHash, int nextHash) {
        return (((oldHash * 7) & MASK) + (nextHash & MASK)) & MASK;
    }

    public static int _combine(int oldHash, int nextHash) {
        return (((oldHash * 7) & MASK) + (nextHash & MASK)) & MASK;
    }

    public default int combine(int oldHash, int power, int nextHash) {
        long left = oldHash;
        int power127 = power & 127;
        int power128 = power >> 7; // power / 128
        int power16383 = power128 & 127;
        int power16384 = power128 >> 7;
        if (power16384 > 0) {
            int power2097151 = power16384 & 127;
            int power2097152 = power16384 >> 7;
            int power268435455 = power2097152 & 127;
            // x * SEVENTH268435456 == x !!!
            left = (left * SEVENTH2097152[power268435455]) & LONG_MASK;
            left = (left * SEVENTH16384[power2097151]) & LONG_MASK;
        }
        left = (left * SEVENTH128[power16383]) & LONG_MASK;
        left = (left * SEVENTH[power127]) & LONG_MASK;
        return ((int) left + nextHash) & MASK;
    }

    public default int replace(int oldHash, int power, int hashCodeOld, int hashCodeNew) {
        long change = hashCodeNew > hashCodeOld
                ? hashCodeNew - hashCodeOld
                : (LIMIT - hashCodeOld) + hashCodeNew;

        int power127 = power & 127;
        int power128 = power >> 7; // power / 128
        int power16383 = power128 & 127;
        int power16384 = power128 >> 7;
        if (power16384 > 0) {
            int power2097151 = power16384 & 127;
            int power2097152 = power16384 >> 7;
            int power268435455 = power2097152 & 127;
            // x * SEVENTH268435456 == x !!!
            change = (change * SEVENTH2097152[power268435455]) & LONG_MASK;
            change = (change * SEVENTH16384[power2097151]) & LONG_MASK;
        }
        change = (change * SEVENTH128[power16383]) & LONG_MASK;
        change = (change * SEVENTH[power127]) & LONG_MASK;
        return ((int) change + oldHash) & MASK;
    }

}
